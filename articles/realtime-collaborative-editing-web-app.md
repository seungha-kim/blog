# 2021-07 실시간 동시편집 웹 어플리케이션 PoC - 아키텍처 이야기

요약 - Figma 블로그 내용을 바탕으로, 단일리더 분산 시스템에 기반한 간단한 실시간 동시편집 웹 어플리케이션을 만들어 본 경험을 소개한다.

이 문서에서 사용하는 실시간 이라는 용어는 일반적으로 준-실시간으로 일컬어지는 정도의 수준을 뜻하며, 수 초 정도의 지연은 장애가 아닌 것으로 본다.

## 실시간 동시편집 웹 어플리케이션의 요구사항

- (필수) 여러 사용자가 네트워크로 상호간 연결된 상태에서 하나의 문서를 편집한다
- (필수) 다른 사용자가 편집한 내용을 실시간으로 확인할 수 있다
- (필수) 내가 편집한 내용을 되돌릴 수 있다. (undo, redo)
- (필수) 잠깐 동안 네트워크에 문제가 생기더라도, 문제없이 편집을 이어나갈 수 있다.
- (선택) 서로 독립적으로 편집된 두 문서를 병합할 수 있다.
- (선택) 서버에 접속하지 않고도 편집을 할 수 있다. (오프라인 편집)
- (선택) 다른 사용자가 어떤 행동을 하고 있는지 실시간으로 확인할 수 있다.

## 해결해야 하는 문제

- 편집 시점의 차이 때문에, 혹은 서로 독립적으로 편집되었기 때문에 두 클라이언트의 편집 내용 간 충돌이 발생할 수 있다.

## Figma에서 공개한 내용

일반적으로는 CRDT가 회자된다. 하지만 Figma 는 CRDT를 사용하지 않음

`TODO`
- Figma 글 요약
	- CRDT 까지 필요하지 않다. CRDT는 복잡... 이런 방식은 구현이 간단해서

단일 리더 분산 시스템 - 실제로 이런 제약사항 때문에 Figma 서버에 문제가 생기면 아예 편집기를 쓸 수 없는 상황이 발생하기도 한다.

`TODO` 회사 Slack 에서 찾아보기

## 기술 스택

- Rust, WASM
- 드로잉은 간단히 하기 위해서 SVG 선택 - 2D canvas api를 사용하거나 CanvanKit 같은 것 사용할 수 있을 것
- Preact - React가 익숙한데 SVG 그대로 쓸 수 있기 때문에 선택

## 아키텍처 설계

- 아키텍처 오버뷰 `TODO`그림 그리기

### 인메모리 키벨류 데이터베이스

- 간단한 트랜잭션 키-밸류 인 메모리 데이터베이스 - 트랜잭션 레이어링 아이디어 `TODO`그림 그리기
- invalidation `TODO`그림 그리기

## 여러가지 선택사항

- validation nack 어떻게 할 것인가
- undo 하다가 validation error가 난다면? 일부만 적용할 것인가? undo stack을 날려버릴 것인가?

## 남겨진 과제

- high availability
- persistence - 분산 트랜잭션을 지원하는 분산 데이터베이스... MongoDB 를 사용하면 되지 않을까?

## 참고 자료

- Figma 글
- Designing Data-Intensive Applications
